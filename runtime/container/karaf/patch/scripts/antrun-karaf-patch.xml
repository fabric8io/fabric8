<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<project default="build">

  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->
  <property name="etc.dir" value="${basedir}/etc" />
  <property name="output.dir" value="${basedir}/target" />
  <property name="resources.dir" value="${basedir}/src/main/resources" />
  <property name="karaf.patch.dir" value="${output.dir}/karaf-patch" />
  <property name="karaf.source.dir" value="${output.dir}/apache-karaf-${apache.karaf.version}" />
  <property name="deploy.artifacts.dir" value="${output.dir}/deploy-artifacts" />
  <property name="deploy.artifacts.lib" value="${deploy.artifacts.dir}/lib" />
  <property name="deploy.artifacts.resources" value="${deploy.artifacts.dir}/resources" />

  <!-- ================================================================== -->
  <!-- Initialization                                                     -->
  <!-- ================================================================== -->
  <target name="init">
  </target>

  <!-- ================================================================== -->
  <!-- Distribution                                                       -->
  <!-- ================================================================== -->
  <target name="build" depends="init">

  	<!-- Copy to system -->
    <copy todir="${karaf.patch.dir}/system/com/google/guava/${google.guava.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/guava-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-beanutils/commons-beanutils/${commons.beanutils.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-beanutils-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-codec/commons-codec/${commons.codec.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-codec-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-collections/commons-collections/${commons.collections.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-collections-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.eventadmin/${apache.felix.eventadmin.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.eventadmin-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.metatype/${apache.felix.metatype.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.metatype-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.scr/${apache.felix.scr.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.scr-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/karaf/admin/org.apache.karaf.admin.core/${apache.karaf.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.karaf.admin.core-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/karaf/admin/org.apache.karaf.admin.management/${apache.karaf.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.karaf.admin.management-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jasypt/${apache.servicemix.jasypt.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.servicemix.bundles.jasypt-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jsch/${apache.servicemix.jsch.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.servicemix.bundles.jsch-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/codehaus/jackson/${codehaus.jackson.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/jackson-core-asl-*.jar" />
        <fileset file="${deploy.artifacts.lib}/jackson-mapper-asl-*.jar" />
    </copy>
    <copy tofile="${karaf.patch.dir}/system/org/jledit/${jledit.version}/jledit-core-${jledit.version}.jar" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/core-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/io/fabric8/${project.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/fabric-api-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-boot-commands-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-core-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-groups-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-git-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-git-server-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-jaas-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-zookeeper-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/fusesource/insight/insight-log/${project.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/insight-log-*.jar" />
    </copy>
  	
  	<!-- Copy to etc -->
    <copy todir="${karaf.patch.dir}" overwrite="true">
        <fileset file="${etc.dir}/karaf/**" />
    </copy>

    <copy file="${karaf.source.dir}/etc/startup.properties" todir="${karaf.patch.dir}/etc" overwrite="true"/>
  	<!--
  	<replace file="${karaf.patch.dir}/etc/startup.properties">
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.osgi" value="#org/apache/karaf/shell/org.apache.karaf.shell.osgi"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.log" value="#org/apache/karaf/shell/org.apache.karaf.shell.log"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.packages" value="#org/apache/karaf/shell/org.apache.karaf.shell.packages"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.commands" value="#org/apache/karaf/shell/org.apache.karaf.shell.commands"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.dev" value="#org/apache/karaf/shell/org.apache.karaf.shell.dev"/>
  		<replacefilter token="org/apache/karaf/jaas/org.apache.karaf.jaas.command" value="#org/apache/karaf/jaas/org.apache.karaf.jaas.command"/>
  		<replacefilter token="org/apache/karaf/features/org.apache.karaf.features" value="#org/apache/karaf/features/org.apache.karaf.features"/>
  		<replacefilter token="org/apache/aries/jmx/org.apache.aries.jmx.blueprint" value="#org/apache/aries/jmx/org.apache.aries.jmx.blueprint"/>
    </replace>
    -->
    <echo file="${karaf.patch.dir}/etc/startup.properties" append="true">

#
# Gravia Integration
# 
org/apache/felix/org.apache.felix.eventadmin/${apache.felix.eventadmin.version}/org.apache.felix.eventadmin-${apache.felix.eventadmin.version}.jar=40
org/apache/felix/org.apache.felix.http/${apache.felix.http.version}/org.apache.felix.http.bundle-${apache.felix.http.version}.jar=40
org/apache/felix/org.apache.felix.metatype/${apache.felix.metatype.version}/org.apache.felix.metatype-${apache.felix.metatype.version}.jar=40
org/apache/felix/org.apache.felix.scr/${apache.felix.scr.version}/org.apache.felix.scr-${apache.felix.scr.version}.jar=40
org/jboss/gravia/${jboss.gravia.version}/gravia-resource-${jboss.gravia.version}.jar=40
org/jboss/gravia/${jboss.gravia.version}/gravia-runtime-api-${jboss.gravia.version}.jar=40
org/jboss/gravia/${jboss.gravia.version}/gravia-runtime-osgi-${jboss.gravia.version}.jar=40
org/jboss/gravia/${jboss.gravia.version}/gravia-repository-${jboss.gravia.version}.jar=41
org/jboss/gravia/${jboss.gravia.version}/gravia-resolver-${jboss.gravia.version}.jar=41
org/jboss/gravia/${jboss.gravia.version}/gravia-provision-${jboss.gravia.version}.jar=42
#
# Fuse Integration
# 
com/google/guava/${google.guava.version}/guava-${google.guava.version}.jar=45
commons-beanutils/commons-beanutils/${commons.beanutils.version}/commons-beanutils-${commons.beanutils.version}.jar=45
commons-codec/commons-codec/${commons.codec.version}/commons-codec-${commons.codec.version}.jar=45
commons-collections/commons-collections/${commons.collections.version}/commons-collections-${commons.collections.version}.jar=45
org/apache/karaf/admin/org.apache.karaf.admin.core/${apache.karaf.version}/org.apache.karaf.admin.core-${apache.karaf.version}.jar=45
org/apache/karaf/admin/org.apache.karaf.admin.management/${apache.karaf.version}/org.apache.karaf.admin.management-${apache.karaf.version}.jar=45
org/apache/servicemix/bundles/org.apache.servicemix.bundles.jasypt/${apache.servicemix.jasypt.version}/org.apache.servicemix.bundles.jasypt-${apache.servicemix.jasypt.version}.jar=45
org/apache/servicemix/bundles/org.apache.servicemix.bundles.jsch/${apache.servicemix.jsch.version}/org.apache.servicemix.bundles.jsch-${apache.servicemix.jsch.version}.jar=45
org/codehaus/jackson/${codehaus.jackson.version}/jackson-core-asl-${codehaus.jackson.version}.jar=46
org/codehaus/jackson/${codehaus.jackson.version}/jackson-mapper-asl-${codehaus.jackson.version}.jar=46
org/jledit/${jledit.version}/jledit-core-${jledit.version}.jar=46
io/fabric8/${project.version}/fabric-api-${project.version}.jar=46
io/fabric8/${project.version}/fabric-boot-commands-${project.version}.jar=46
io/fabric8/${project.version}/fabric-core-${project.version}.jar=46
io/fabric8/${project.version}/fabric-groups-${project.version}.jar=46
io/fabric8/${project.version}/fabric-git-${project.version}.jar=46
io/fabric8/${project.version}/fabric-git-server-${project.version}.jar=46
io/fabric8/${project.version}/fabric-jaas-${project.version}.jar=46
io/fabric8/${project.version}/fabric-zookeeper-${project.version}.jar=46
org/fusesource/insight/insight-log/${project.version}/insight-log-${project.version}.jar=46
    </echo>
  	
    <copy file="${karaf.source.dir}/etc/custom.properties" todir="${karaf.patch.dir}/etc" overwrite="true"/>
    <echo file="${karaf.patch.dir}/etc/custom.properties" append="true">
# Clean the persitent bundle store on Framework INIT                                
org.osgi.framework.storage.clean=onFirstInit

# Enable Jetty HttpService
org.apache.felix.http.jettyEnabled=true
org.osgi.service.http.port=8080
    	
# Gravia properties
org.jboss.gravia.repository.storage.dir=${karaf.data}/repository
org.jboss.gravia.runtime.type=karaf
    	
# The Felix Framewok log level 
#
# ERROR = 1;
# WARNING = 2;
# INFO = 3;
# DEBUG = 4;
# felix.log.level=4
    </echo>
  	
  	<!-- Build the karaf patch -->
  	<tar destfile="${output.dir}/${project.artifactId}-${project.version}.tar.gz" basedir="${karaf.patch.dir}" compression="gzip"/>
  </target>
</project>
