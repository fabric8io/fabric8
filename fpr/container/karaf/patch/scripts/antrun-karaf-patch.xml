<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<project default="build">

  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->
  <property name="etc.dir" value="${basedir}/etc" />
  <property name="output.dir" value="${basedir}/target" />
  <property name="resources.dir" value="${basedir}/src/main/resources" />
  <property name="karaf.patch.dir" value="${output.dir}/karaf-patch" />
  <property name="karaf.source.dir" value="${output.dir}/apache-karaf-${karaf-version}" />
  <property name="deploy.artifacts.dir" value="${output.dir}/deploy-artifacts" />
  <property name="deploy.artifacts.lib" value="${deploy.artifacts.dir}/lib" />
  <property name="deploy.artifacts.resources" value="${deploy.artifacts.dir}/resources" />

  <!-- ================================================================== -->
  <!-- Initialization                                                     -->
  <!-- ================================================================== -->
  <target name="init">
  </target>

  <!-- ================================================================== -->
  <!-- Distribution                                                       -->
  <!-- ================================================================== -->
  <target name="build" depends="init">

  	<!-- Copy to system -->
    <copy todir="${karaf.patch.dir}/system/com/google/guava/${guava-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/guava-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-beanutils/commons-beanutils/${commons-beanutils-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-beanutils-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-codec/commons-codec/${commons-codec-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-codec-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/commons-collections/commons-collections/${commons-collections-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/commons-collections-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.eventadmin/${felix-eventadmin-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.eventadmin-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.metatype/${felix-metatype-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.metatype-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/felix/org.apache.felix.scr/${felix-scr-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.felix.scr-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/karaf/admin/org.apache.karaf.admin.core/${karaf-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.karaf.admin.core-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/karaf/admin/org.apache.karaf.admin.management/${karaf-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.karaf.admin.management-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jasypt/${jasypt-smx-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.servicemix.bundles.jasypt-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/apache/servicemix/bundles/org.apache.servicemix.bundles.jsch/${jsch-smx-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/org.apache.servicemix.bundles.jsch-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/codehaus/jackson/${jackson-version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/jackson-core-asl-*.jar" />
        <fileset file="${deploy.artifacts.lib}/jackson-mapper-asl-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/io/fabric8/${project.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/fabric-api-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-core-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-groups-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-git-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-git-server-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-jaas-*.jar" />
        <fileset file="${deploy.artifacts.lib}/fabric-zookeeper-*.jar" />
    </copy>
    <copy todir="${karaf.patch.dir}/system/org/fusesource/insight/insight-log/${project.version}" overwrite="true">
        <fileset file="${deploy.artifacts.lib}/insight-log-*.jar" />
    </copy>
  	
  	<!-- Copy to etc -->
    <copy todir="${karaf.patch.dir}" overwrite="true">
        <fileset file="${etc.dir}/**" />
    </copy>

    <copy file="${karaf.source.dir}/etc/startup.properties" todir="${karaf.patch.dir}/etc" overwrite="true"/>
  	<replace file="${karaf.patch.dir}/etc/startup.properties">
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.osgi" value="#org/apache/karaf/shell/org.apache.karaf.shell.osgi"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.log" value="#org/apache/karaf/shell/org.apache.karaf.shell.log"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.packages" value="#org/apache/karaf/shell/org.apache.karaf.shell.packages"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.commands" value="#org/apache/karaf/shell/org.apache.karaf.shell.commands"/>
  		<replacefilter token="org/apache/karaf/shell/org.apache.karaf.shell.dev" value="#org/apache/karaf/shell/org.apache.karaf.shell.dev"/>
  		<replacefilter token="org/apache/karaf/jaas/org.apache.karaf.jaas.command" value="#org/apache/karaf/jaas/org.apache.karaf.jaas.command"/>
  		<replacefilter token="org/apache/karaf/features/org.apache.karaf.features" value="#org/apache/karaf/features/org.apache.karaf.features"/>
  		<replacefilter token="org/apache/aries/jmx/org.apache.aries.jmx.blueprint" value="#org/apache/aries/jmx/org.apache.aries.jmx.blueprint"/>
    </replace>
    <echo file="${karaf.patch.dir}/etc/startup.properties" append="true">
#
# Gravia Integration
# 
org/apache/felix/org.apache.felix.eventadmin/${felix-eventadmin-version}/org.apache.felix.eventadmin-${felix-eventadmin-version}.jar=40
org/apache/felix/org.apache.felix.http/${felix-http-version}/org.apache.felix.http.bundle-${felix-http-version}.jar=40
org/apache/felix/org.apache.felix.metatype/${felix-metatype-version}/org.apache.felix.metatype-${felix-metatype-version}.jar=40
org/apache/felix/org.apache.felix.scr/${felix-scr-version}/org.apache.felix.scr-${felix-scr-version}.jar=40
org/jboss/gravia/${gravia-version}/gravia-resource-${gravia-version}.jar=40
org/jboss/gravia/${gravia-version}/gravia-runtime-api-${gravia-version}.jar=40
org/jboss/gravia/${gravia-version}/gravia-runtime-osgi-${gravia-version}.jar=40
#
# Fuse Integration
# 
com/google/guava/${guava-version}/guava-${guava-version}.jar=45
commons-beanutils/commons-beanutils/${commons-beanutils-version}/commons-beanutils-${commons-beanutils-version}.jar=40
commons-codec/commons-codec/${commons-codec-version}/commons-codec-${commons-codec-version}.jar=40
commons-collections/commons-collections/${commons-collections-version}/commons-collections-${commons-collections-version}.jar=40
org/apache/karaf/admin/org.apache.karaf.admin.core/${karaf-version}/org.apache.karaf.admin.core-${karaf-version}.jar=40
org/apache/karaf/admin/org.apache.karaf.admin.management/${karaf-version}/org.apache.karaf.admin.management-${karaf-version}.jar=40
org/apache/servicemix/bundles/org.apache.servicemix.bundles.jasypt/${jasypt-smx-version}/org.apache.servicemix.bundles.jasypt-${jasypt-smx-version}.jar=35
org/apache/servicemix/bundles/org.apache.servicemix.bundles.jsch/${jsch-smx-version}/org.apache.servicemix.bundles.jsch-${jsch-smx-version}.jar=35
org/codehaus/jackson/${jackson-version}/jackson-core-asl-${jackson-version}.jar=45
org/codehaus/jackson/${jackson-version}/jackson-mapper-asl-${jackson-version}.jar=45
io/fabric8/${project.version}/fabric-api-${project.version}.jar=45
io/fabric8/${project.version}/fabric-core-${project.version}.jar=45
io/fabric8/${project.version}/fabric-groups-${project.version}.jar=45
io/fabric8/${project.version}/fabric-git-${project.version}.jar=45
io/fabric8/${project.version}/fabric-git-server-${project.version}.jar=45
io/fabric8/${project.version}/fabric-jaas-${project.version}.jar=45
io/fabric8/${project.version}/fabric-zookeeper-${project.version}.jar=45
org/fusesource/insight/insight-log/${project.version}/insight-log-${project.version}.jar=45
#
# Arquillian OSGi Integration
# 
org/jboss/arquillian/osgi/${arquillian-osgi-version}/arquillian-osgi-bundle-${arquillian-osgi-version}.jar=50
    </echo>

  	
    <copy file="${karaf.source.dir}/etc/custom.properties" todir="${karaf.patch.dir}/etc" overwrite="true"/>
    <echo file="${karaf.patch.dir}/etc/custom.properties" append="true">
# Clean the persitent bundle store on Framework INIT                                
org.osgi.framework.storage.clean=onFirstInit

# Enable Jetty HttpService
org.apache.felix.http.jettyEnabled=true
org.osgi.service.http.port=8080
    	
# The Runtime type
org.jboss.gravia.runtime.type=karaf
    	
# The Felix Framewok log level 
#
# ERROR = 1;
# WARNING = 2;
# INFO = 3;
# DEBUG = 4;
# felix.log.level=4
    </echo>
  	
    <copy file="${karaf.source.dir}/etc/system.properties" todir="${karaf.patch.dir}/etc" overwrite="true"/>
    <echo file="${karaf.patch.dir}/etc/system.properties" append="true">

# Fabric properties
ensemble.auto.start=true
    </echo>
  	
  	<!-- Zip the karaf patch -->
  	<zip destfile="${output.dir}/${project.artifactId}-${project.version}.zip" basedir="${karaf.patch.dir}"/>
  	<tar destfile="${output.dir}/${project.artifactId}-${project.version}.tar.gz" basedir="${karaf.patch.dir}" compression="gzip"/>
  </target>
</project>
